---
# Source: etcd-operator/templates/operator-service-account.yaml

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: etcd-etcd-operator-etcd-operator
  labels:
    chart: "etcd-operator-0.9.5"
    app: etcd-operator
    heritage: Tiller
    release: etcd
---
# Source: etcd-operator/templates/operator-cluster-role.yaml

apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: etcd-etcd-operator-etcd-operator
  labels:
    chart: "etcd-operator-0.9.5"
    app: etcd-operator
    heritage: Tiller
    release: etcd
rules:
- apiGroups:
  - etcd.database.coreos.com
  resources:
  - etcdclusters
  - etcdbackups
  - etcdrestores
  verbs:
  - "*"
- apiGroups:
  - ""
  resources:
  - pods
  - services
  - endpoints
  - persistentvolumeclaims
  - events
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - "*"
# The following permissions can be removed if not using S3 backup and TLS
- apiGroups:
  - ""
  resources: 
  - secrets
  verbs:
  - get

---
# Source: etcd-operator/templates/operator-clusterrole-binding.yaml

apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: etcd-etcd-operator-etcd-operator
  namespace: hkube1
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: etcd-etcd-operator-etcd-operator
subjects:
- kind: ServiceAccount
  name: etcd-etcd-operator-etcd-operator
  namespace: hkube1

---
# Source: etcd-operator/templates/operator-deployment.yaml

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: etcd-etcd-operator-etcd-operator
  labels:
    chart: "etcd-operator-0.9.5"
    app: etcd-operator
    heritage: Tiller
    release: etcd
spec:
  replicas: 1
  template:
    metadata:
      name: etcd-etcd-operator-etcd-operator
      labels:
        app: etcd-etcd-operator-etcd-operator
        release: etcd
    spec:
      serviceAccountName: etcd-etcd-operator-etcd-operator
      containers:
      - name: etcd-etcd-operator-etcd-operator
        image: "quay.io/coreos/etcd-operator:v0.9.2"
        imagePullPolicy: Always
        command:
        - etcd-operator
        - "--create-crd=false"
        env:
        - name: MY_POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: MY_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 128Mi

---
# Source: etcd-operator/templates/etcd-cluster.yaml
apiVersion: "etcd.database.coreos.com/v1beta2"
kind: "EtcdCluster"
metadata:
  name: "etcd"
  namespace: hkube1
  labels:
    group: hkube
    app: etcd
    thirdparty: "true"
spec:
  size: 3
  version: "3.3.1"
  repository: "gcr.io/etcd-development/etcd"
  pod:
    busyboxImage: "busybox:1.28.0-glibc"
    nodeSelector:
      third-party: "true"
    # resources:
    #   limits:
    #     cpu: 300m
    #     memory: 200Mi
    #   requests:
    #     cpu: 200m
    #     memory: 100Mi
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: etcd_cluster
                operator: In
                values:
                - etcd
            topologyKey: kubernetes.io/hostname
    etcdEnv:
    - name: ETCD_HEARTBEAT_INTERVAL
      value: "1000"
    - name: ETCD_ELECTION_TIMEOUT
      value: "5000"
    - name: ETCD_AUTO_COMPACTION_RETENTION
      value: "5m"
    - name: ETCD_AUTO_COMPACTION_MODE
      value: "periodic"
    - name: ETCD_QUOTA_BACKEND_BYTES
    # 8GB
      value: "8589934592"
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "2379"

---
# Source: etcd-operator/templates/backup-etcd-crd.yaml

---
# Source: etcd-operator/templates/backup-operator-clusterrole-binding.yaml


---
# Source: etcd-operator/templates/backup-operator-deployment.yaml


---
# Source: etcd-operator/templates/backup-operator-service-account.yaml

---
# Source: etcd-operator/templates/create-crd-hook.yaml

---
# Source: etcd-operator/templates/etcd-cluster-crd.yaml



---
# Source: etcd-operator/templates/restore-etcd-crd.yaml

---
# Source: etcd-operator/templates/restore-operator-clusterrole-binding.yaml


---
# Source: etcd-operator/templates/restore-operator-deployment.yaml


---
# Source: etcd-operator/templates/restore-operator-service-account.yaml

---
# Source: etcd-operator/templates/restore-operator-service.yaml


